{%- assign offer_product = all_products[settings.primary_product_handle] -%}
{%- assign offer_variant = nil -%}
{%- assign offer_allocations = nil -%}
{%- if offer_product != blank -%}
  {%- assign offer_variant = offer_product.selected_or_first_available_variant -%}
  {%- assign offer_allocations = offer_variant.selling_plan_allocations -%}
{%- endif -%}

<section class="offer">
  <div class="offer-left">
    <h2 class="offer-product-title">{{ section.settings.product_title | default: 'Hr²' }}</h2>

    <p class="offer-product-description">
      {{ section.settings.product_description | default: 'Hr² ist dein tägliches Supplement für die Haargesundheit – entwickelt mit einem Fokus auf ausgewählte Inhaltsstoffe, Qualitätssicherung und eine einfache Routine.' }}
    </p>

    <div class="offer-plans" role="radiogroup" aria-label="Lieferoptionen">
      {%- if offer_product != blank and offer_variant != blank and offer_product.selling_plan_groups.size > 0 -%}
        {%- assign offer_group = offer_product.selling_plan_groups.first -%}
        {%- for plan in offer_group.selling_plans limit: 3 -%}
          {%- assign matched_allocation = blank -%}
          {%- for allocation in offer_allocations -%}
            {%- if allocation.selling_plan and allocation.selling_plan.id == plan.id -%}
              {%- assign matched_allocation = allocation -%}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}

          {%- assign adjustment = plan.price_adjustments | first -%}
          {%- assign option_old_price = offer_variant.price -%}
          {%- assign option_new_price = offer_variant.price -%}

          {%- if matched_allocation and matched_allocation.price -%}
            {%- assign option_new_price = matched_allocation.price -%}
            {%- if matched_allocation.compare_at_price and matched_allocation.compare_at_price > matched_allocation.price -%}
              {%- assign option_old_price = matched_allocation.compare_at_price -%}
            {%- endif -%}
          {%- elsif adjustment -%}
            {%- if adjustment.value_type == 'percentage' -%}
              {%- assign discount_amount = offer_variant.price | times: adjustment.value | divided_by: 100 -%}
              {%- assign option_new_price = offer_variant.price | minus: discount_amount -%}
            {%- elsif adjustment.value_type == 'fixed_amount' -%}
              {%- assign option_new_price = offer_variant.price | minus: adjustment.value -%}
            {%- elsif adjustment.value_type == 'price' -%}
              {%- assign option_new_price = adjustment.value -%}
            {%- endif -%}
          {%- endif -%}

          {%- if option_new_price < 0 -%}
            {%- assign option_new_price = 0 -%}
          {%- endif -%}

          {%- assign save_text = '' -%}
          {%- if adjustment and adjustment.value_type == 'percentage' -%}
            {%- assign save_text = 'SPARE ' | append: adjustment.value | append: '%' -%}
          {%- elsif adjustment and adjustment.value_type == 'fixed_amount' -%}
            {%- assign save_text = 'SPARE ' | append: adjustment.value | money -%}
          {%- endif -%}

          <label class="offer-plan{% if forloop.first %} is-selected{% endif %}">
            <input class="offer-plan-radio" type="radio" name="offer-plan" value="{{ plan.id }}" {% if forloop.first %}checked{% endif %}>
            <div class="offer-plan-title">
              <span class="offer-plan-name">{{ plan.name }}</span>
              {% if save_text != '' %}
                <span class="offer-plan-badge">{{ save_text }}</span>
              {% endif %}
            </div>
            <div class="offer-plan-price">
              {% if option_new_price < option_old_price %}
                <div class="offer-plan-price-old">{{ option_old_price | money }}</div>
              {% endif %}
              <div class="offer-plan-price-new">{{ option_new_price | money }}</div>
            </div>
          </label>
        {%- endfor -%}
      {%- else -%}
        {% for block in section.blocks %}
          {% if block.type == 'plan' %}
            <label class="offer-plan{% if forloop.first %} is-selected{% endif %}" {{ block.shopify_attributes }}>
              <input class="offer-plan-radio" type="radio" name="offer-plan" value="{{ block.settings.value }}" {% if forloop.first %}checked{% endif %}>
              <div class="offer-plan-title">
                <span class="offer-plan-name">{{ block.settings.name }}</span>
                {% if block.settings.badge != blank %}
                  <span class="offer-plan-badge">{{ block.settings.badge }}</span>
                {% endif %}
              </div>
              <div class="offer-plan-price">
                {% if block.settings.price_old != blank %}
                  <div class="offer-plan-price-old">{{ block.settings.price_old }}</div>
                {% endif %}
                <div class="offer-plan-price-new">{{ block.settings.price_new }}</div>
              </div>
            </label>
          {% endif %}
        {% endfor %}
      {%- endif -%}
    </div>

    <a class="offer-start-btn" href="{{ routes.root_url }}products/{{ settings.primary_product_handle }}">{{ section.settings.cta_text | default: 'In den Warenkorb' }}</a>

    <div class="offer-guarantee-row">
      <span>✔ Kostenloser Versand</span>
      <span>✔ Jederzeit kündbar</span>
      <span>✔ 30‑Tage‑Geld‑zurück</span>
    </div>
  </div>

  <div class="offer-right">
    <div class="offer-tagline">{{ section.settings.promo_tagline | default: 'Das erste Mal. Nur für kurze Zeit.' }}</div>
    <h3>{{ section.settings.promo_heading | default: 'Dein Hr² jetzt für 29€' }}</h3>
    {% if section.settings.promo_image != blank %}
      <img src="{{ section.settings.promo_image | image_url: width: 600 }}" alt="{{ section.settings.promo_image.alt | default: 'Hr² Bundle' }}" loading="lazy" decoding="async">
    {% else %}
      <img src="{{ 'bottlew.png' | asset_url }}" alt="Hr² Bundle" loading="lazy" decoding="async">
    {% endif %}
  </div>
</section>

{% schema %}
{
  "name": "Angebot & Preise",
  "tag": "section",
  "class": "section-offer",
  "settings": [
    {
      "type": "text",
      "id": "product_title",
      "label": "Produkt-Titel",
      "default": "Hr²"
    },
    {
      "type": "textarea",
      "id": "product_description",
      "label": "Produkt-Beschreibung",
      "default": "Hr² ist dein tägliches Supplement für die Haargesundheit – entwickelt mit einem Fokus auf ausgewählte Inhaltsstoffe, Qualitätssicherung und eine einfache Routine."
    },
    {
      "type": "text",
      "id": "cta_text",
      "label": "CTA Button Text",
      "default": "In den Warenkorb"
    },
    {
      "type": "checkbox",
      "id": "show_one_time",
      "label": "Einmalkauf anzeigen",
      "default": true
    },
    {
      "type": "text",
      "id": "one_time_text",
      "label": "Einmalkauf Text",
      "default": "Einmal kaufen für 39€ + 4,95€ Versand"
    },
    {
      "type": "text",
      "id": "guarantee_text",
      "label": "Garantie Text",
      "default": "Kostenloser Versand. Jederzeit pausieren oder kündigen."
    },
    {
      "type": "header",
      "content": "Promo Bereich"
    },
    {
      "type": "text",
      "id": "promo_tagline",
      "label": "Promo Tagline",
      "default": "Das erste Mal. Nur für kurze Zeit."
    },
    {
      "type": "text",
      "id": "promo_heading",
      "label": "Promo Überschrift",
      "default": "Dein Hr² jetzt für 29€"
    },
    {
      "type": "image_picker",
      "id": "promo_image",
      "label": "Promo Bild"
    }
  ],
  "blocks": [
    {
      "type": "plan",
      "name": "Abo-Plan",
      "settings": [
        {
          "type": "text",
          "id": "value",
          "label": "Wert (für Formular)",
          "default": "monthly"
        },
        {
          "type": "text",
          "id": "name",
          "label": "Plan Name",
          "default": "Monatliche Lieferung"
        },
        {
          "type": "text",
          "id": "badge",
          "label": "Badge Text",
          "default": "Spare 10%"
        },
        {
          "type": "text",
          "id": "price_new",
          "label": "Neuer Preis",
          "default": "35€"
        },
        {
          "type": "text",
          "id": "price_old",
          "label": "Alter Preis (durchgestrichen)",
          "default": "39€"
        },
        {
          "type": "text",
          "id": "description",
          "label": "Beschreibung",
          "default": "1-Monats-Vorrat, Lieferung monatlich."
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Angebot & Preise",
      "blocks": [
        {
          "type": "plan",
          "settings": {
            "value": "monthly",
            "name": "Monatlich",
            "badge": "Spare 15%",
            "price_new": "29€",
            "price_old": "49€"
          }
        },
        {
          "type": "plan",
          "settings": {
            "value": "3month",
            "name": "3 Monate",
            "badge": "Spare 20%",
            "price_new": "58€",
            "price_old": "98€"
          }
        },
        {
          "type": "plan",
          "settings": {
            "value": "6month",
            "name": "6 Monate",
            "badge": "Spare 25%",
            "price_new": "116€",
            "price_old": "196€"
          }
        }
      ]
    }
  ]
}
{% endschema %}
