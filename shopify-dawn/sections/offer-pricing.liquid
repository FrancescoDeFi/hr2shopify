{%- assign offer_product = all_products[settings.primary_product_handle] -%}
{%- assign offer_variant = nil -%}
{%- assign offer_allocations = nil -%}
{%- assign offer_product_title = section.settings.product_title -%}
{%- assign offer_product_description = section.settings.product_description -%}
{%- assign offer_cta_text = section.settings.cta_text -%}
{%- assign offer_promo_tagline = section.settings.promo_tagline -%}
{%- assign offer_promo_heading = section.settings.promo_heading -%}
{%- if offer_product != blank -%}
  {%- assign offer_variant = offer_product.selected_or_first_available_variant -%}
  {%- assign offer_allocations = offer_variant.selling_plan_allocations -%}
{%- endif -%}
{%- if request.locale.iso_code == 'en' -%}
  {%- assign offer_product_title = blank -%}
  {%- assign offer_product_description = blank -%}
  {%- assign offer_cta_text = blank -%}
  {%- assign offer_promo_tagline = blank -%}
  {%- assign offer_promo_heading = blank -%}
{%- endif -%}
{%- if offer_product_title == blank -%}{%- assign offer_product_title = 'offer.product_title' | t -%}{%- endif -%}
{%- if offer_product_description == blank -%}{%- assign offer_product_description = 'offer.product_description' | t -%}{%- endif -%}
{%- if offer_cta_text == blank -%}{%- assign offer_cta_text = 'offer.cta' | t -%}{%- endif -%}
{%- if offer_promo_tagline == blank -%}{%- assign offer_promo_tagline = 'offer.promo_tagline' | t -%}{%- endif -%}
{%- if offer_promo_heading == blank -%}{%- assign offer_promo_heading = 'offer.promo_heading' | t -%}{%- endif -%}

<section class="offer">
  <div class="offer-left">
    <h2 class="offer-product-title">{{ offer_product_title }}</h2>

    <p class="offer-product-description">
      {{ offer_product_description }}
    </p>

    <div class="offer-plans" role="radiogroup" aria-label="{{ 'offer.delivery_options' | t }}">
      {%- if offer_product != blank and offer_variant != blank and offer_product.selling_plan_groups.size > 0 -%}
        {%- assign offer_group = offer_product.selling_plan_groups.first -%}
        {%- for plan in offer_group.selling_plans limit: 3 -%}
          {%- assign matched_allocation = blank -%}
          {%- for allocation in offer_allocations -%}
            {%- if allocation.selling_plan and allocation.selling_plan.id == plan.id -%}
              {%- assign matched_allocation = allocation -%}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}

          {%- assign adjustment = plan.price_adjustments | first -%}
          {%- assign option_old_price = offer_variant.price -%}
          {%- assign option_new_price = offer_variant.price -%}

          {%- if matched_allocation and matched_allocation.price -%}
            {%- assign option_new_price = matched_allocation.price -%}
            {%- if matched_allocation.compare_at_price and matched_allocation.compare_at_price > matched_allocation.price -%}
              {%- assign option_old_price = matched_allocation.compare_at_price -%}
            {%- endif -%}
          {%- elsif adjustment -%}
            {%- if adjustment.value_type == 'percentage' -%}
              {%- assign discount_amount = offer_variant.price | times: adjustment.value | divided_by: 100 -%}
              {%- assign option_new_price = offer_variant.price | minus: discount_amount -%}
            {%- elsif adjustment.value_type == 'fixed_amount' -%}
              {%- assign option_new_price = offer_variant.price | minus: adjustment.value -%}
            {%- elsif adjustment.value_type == 'price' -%}
              {%- assign option_new_price = adjustment.value -%}
            {%- endif -%}
          {%- endif -%}

          {%- if option_new_price < 0 -%}
            {%- assign option_new_price = 0 -%}
          {%- endif -%}

          {%- assign save_text = '' -%}
          {%- if adjustment and adjustment.value_type == 'percentage' -%}
            {%- assign save_text = 'offer.save_prefix' | t | append: ' ' | append: adjustment.value | append: '%' -%}
          {%- elsif adjustment and adjustment.value_type == 'fixed_amount' -%}
            {%- assign save_text = 'offer.save_prefix' | t | append: ' ' | append: adjustment.value | money -%}
          {%- endif -%}
          {%- assign localized_plan_name = plan.name -%}
          {%- if request.locale.iso_code == 'de' -%}
            {%- assign localized_plan_name = plan.name
              | replace: 'Deliver every month', 'Lieferung jeden Monat'
              | replace: 'Deliver every 1 month', 'Lieferung jeden Monat'
              | replace: 'Deliver every 3 months', 'Lieferung alle 3 Monate'
              | replace: 'Deliver every 6 months', 'Lieferung alle 6 Monate'
              | replace: 'DELIVER EVERY MONTH', 'LIEFERUNG JEDEN MONAT'
              | replace: 'DELIVER EVERY 1 MONTH', 'LIEFERUNG JEDEN MONAT'
              | replace: 'DELIVER EVERY 3 MONTHS', 'LIEFERUNG ALLE 3 MONATE'
              | replace: 'DELIVER EVERY 6 MONTHS', 'LIEFERUNG ALLE 6 MONATE'
              | replace: 'Subscribe and save', 'Abonnieren und sparen'
              | replace: 'SUBSCRIBE AND SAVE', 'ABONNIEREN UND SPAREN'
              | replace: '% off', '% sparen'
              | replace: '% OFF', '% SPAREN'
              | replace: ', 15% sparen', ''
              | replace: ', 20% sparen', ''
              | replace: ', 25% sparen', ''
              | replace: ', 15% SPAREN', ''
              | replace: ', 20% SPAREN', ''
              | replace: ', 25% SPAREN', ''
            -%}
          {%- endif -%}

          <label class="offer-plan{% if forloop.first %} is-selected{% endif %}">
            <input class="offer-plan-radio" type="radio" name="offer-plan" value="{{ plan.id }}" {% if forloop.first %}checked{% endif %}>
            <div class="offer-plan-title">
              <span class="offer-plan-name">{{ localized_plan_name }}</span>
              {% if save_text != '' %}
                <span class="offer-plan-badge">{{ save_text }}</span>
              {% endif %}
            </div>
            <div class="offer-plan-price">
              {% if option_new_price < option_old_price %}
                <div class="offer-plan-price-old">{{ option_old_price | money }}</div>
              {% endif %}
              <div class="offer-plan-price-new">{{ option_new_price | money }}</div>
            </div>
          </label>
        {%- endfor -%}
      {%- else -%}
        {% for block in section.blocks %}
          {% if block.type == 'plan' %}
            <label class="offer-plan{% if forloop.first %} is-selected{% endif %}" {{ block.shopify_attributes }}>
              <input class="offer-plan-radio" type="radio" name="offer-plan" value="{{ block.settings.value }}" {% if forloop.first %}checked{% endif %}>
              <div class="offer-plan-title">
                <span class="offer-plan-name">{{ block.settings.name }}</span>
                {% if block.settings.badge != blank %}
                  <span class="offer-plan-badge">{{ block.settings.badge }}</span>
                {% endif %}
              </div>
              <div class="offer-plan-price">
                {% if block.settings.price_old != blank %}
                  <div class="offer-plan-price-old">{{ block.settings.price_old }}</div>
                {% endif %}
                <div class="offer-plan-price-new">{{ block.settings.price_new }}</div>
              </div>
            </label>
          {% endif %}
        {% endfor %}
      {%- endif -%}
    </div>

    <a class="offer-start-btn" href="{{ routes.root_url }}products/{{ settings.primary_product_handle }}">{{ offer_cta_text }}</a>

    <div class="offer-guarantee-row">
      <span>✔ {{ 'offer.free_shipping' | t }}</span>
      <span>✔ {{ 'offer.cancel_anytime' | t }}</span>
      <span>✔ {{ 'offer.money_back' | t }}</span>
    </div>
  </div>

  <div class="offer-right">
    <div class="offer-tagline">{{ offer_promo_tagline }}</div>
    <h3>{{ offer_promo_heading }}</h3>
    {% if section.settings.promo_image != blank %}
      {%- assign promo_alt = section.settings.promo_image.alt -%}
      {%- if request.locale.iso_code == 'en' or promo_alt == blank -%}
        {%- assign promo_alt = 'offer.bundle_alt' | t -%}
      {%- endif -%}
      <img src="{{ section.settings.promo_image | image_url: width: 600 }}" alt="{{ promo_alt }}" loading="lazy" decoding="async">
    {% else %}
      <img src="{{ 'bottlew.png' | asset_url }}" alt="{{ 'offer.bundle_alt' | t }}" loading="lazy" decoding="async">
    {% endif %}
  </div>
</section>

{% schema %}
{
  "name": "Angebot & Preise",
  "tag": "section",
  "class": "section-offer",
  "settings": [
    {
      "type": "text",
      "id": "product_title",
      "label": "Produkt-Titel",
      "default": "Hr²"
    },
    {
      "type": "textarea",
      "id": "product_description",
      "label": "Produkt-Beschreibung",
      "default": "Hr² ist dein tägliches Supplement für die Haargesundheit – entwickelt mit einem Fokus auf ausgewählte Inhaltsstoffe, Qualitätssicherung und eine einfache Routine."
    },
    {
      "type": "text",
      "id": "cta_text",
      "label": "CTA Button Text",
      "default": "In den Warenkorb"
    },
    {
      "type": "checkbox",
      "id": "show_one_time",
      "label": "Einmalkauf anzeigen",
      "default": true
    },
    {
      "type": "text",
      "id": "one_time_text",
      "label": "Einmalkauf Text",
      "default": "Einmal kaufen für 39€ + 4,95€ Versand"
    },
    {
      "type": "text",
      "id": "guarantee_text",
      "label": "Garantie Text",
      "default": "Kostenloser Versand. Jederzeit pausieren oder kündigen."
    },
    {
      "type": "header",
      "content": "Promo Bereich"
    },
    {
      "type": "text",
      "id": "promo_tagline",
      "label": "Promo Tagline",
      "default": "Das erste Mal. Nur für kurze Zeit."
    },
    {
      "type": "text",
      "id": "promo_heading",
      "label": "Promo Überschrift",
      "default": "Dein Hr² jetzt für 29€"
    },
    {
      "type": "image_picker",
      "id": "promo_image",
      "label": "Promo Bild"
    }
  ],
  "blocks": [
    {
      "type": "plan",
      "name": "Abo-Plan",
      "settings": [
        {
          "type": "text",
          "id": "value",
          "label": "Wert (für Formular)",
          "default": "monthly"
        },
        {
          "type": "text",
          "id": "name",
          "label": "Plan Name",
          "default": "Monatliche Lieferung"
        },
        {
          "type": "text",
          "id": "badge",
          "label": "Badge Text",
          "default": "Spare 10%"
        },
        {
          "type": "text",
          "id": "price_new",
          "label": "Neuer Preis",
          "default": "35€"
        },
        {
          "type": "text",
          "id": "price_old",
          "label": "Alter Preis (durchgestrichen)",
          "default": "39€"
        },
        {
          "type": "text",
          "id": "description",
          "label": "Beschreibung",
          "default": "1-Monats-Vorrat, Lieferung monatlich."
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Angebot & Preise",
      "blocks": [
        {
          "type": "plan",
          "settings": {
            "value": "monthly",
            "name": "Monatlich",
            "badge": "Spare 15%",
            "price_new": "29€",
            "price_old": "49€"
          }
        },
        {
          "type": "plan",
          "settings": {
            "value": "3month",
            "name": "3 Monate",
            "badge": "Spare 20%",
            "price_new": "58€",
            "price_old": "98€"
          }
        },
        {
          "type": "plan",
          "settings": {
            "value": "6month",
            "name": "6 Monate",
            "badge": "Spare 25%",
            "price_new": "116€",
            "price_old": "196€"
          }
        }
      ]
    }
  ]
}
{% endschema %}
